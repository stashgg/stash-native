name: Build Sample Apps

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android Sample APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission for gradlew
        run: chmod +x Android/gradlew
      
      - name: Build Android Sample APK
        working-directory: Android
        run: ./gradlew :sample:assembleRelease
      
      - name: Find APK file
        id: find-apk
        run: |
          APK_PATH=$(find Android/sample/build/outputs/apk -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "APK not found! Searching in Android/sample/build/outputs/apk:"
            ls -la Android/sample/build/outputs/apk/ || true
            find Android/sample/build/outputs -name "*.apk" || true
            exit 1
          fi
          echo "Found APK at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-sample-apk
          path: ${{ steps.find-apk.outputs.apk_path }}
          retention-days: 7
      
      - name: Upload APK to BrowserStack
        id: browserstack-android
        run: |
          APK_PATH="${{ steps.find-apk.outputs.apk_path }}"
          if [ ! -f "$APK_PATH" ]; then
            echo "Error: APK file not found at $APK_PATH"
            exit 1
          fi
          echo "Uploading APK to BrowserStack: $APK_PATH"
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-live/upload" \
            -F "file=@$APK_PATH")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "BrowserStack Android Upload Response:"
          echo "$RESPONSE"

  build-ios:
    name: Build iOS Sample IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Build iOS Sample for Device
        working-directory: iOS/Sample
        run: |
          xcodebuild clean build \
            -project StashPaySample.xcodeproj \
            -scheme StashPaySample \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Create IPA
        working-directory: iOS/Sample
        run: |
          mkdir -p build/Payload
          APP_PATH="build/DerivedData/Build/Products/Release-iphoneos/StashNativeDemo.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: App bundle not found at $APP_PATH"
            echo "Searching for app bundle:"
            find build/DerivedData -name "*.app" -type d || true
            exit 1
          fi
          cp -r "$APP_PATH" build/Payload/
          cd build
          zip -r StashNativeDemo.ipa Payload
          cd ..
          if [ ! -f "build/StashNativeDemo.ipa" ]; then
            echo "Error: IPA file was not created"
            exit 1
          fi
          echo "IPA created successfully at build/StashNativeDemo.ipa"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-sample-ipa
          path: iOS/Sample/build/StashNativeDemo.ipa
          retention-days: 7
          if-no-files-found: error
      
      - name: Upload IPA to BrowserStack
        id: browserstack-ios
        run: |
          IPA_PATH="iOS/Sample/build/StashNativeDemo.ipa"
          if [ ! -f "$IPA_PATH" ]; then
            echo "Error: IPA file not found at $IPA_PATH"
            exit 1
          fi
          echo "Uploading IPA to BrowserStack: $IPA_PATH"
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-live/upload" \
            -F "file=@$IPA_PATH")
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "BrowserStack iOS Upload Response:"
          echo "$RESPONSE"
